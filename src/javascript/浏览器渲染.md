---
title: 浏览器渲染
date: 2023年2月13日21:45:06
categories:
  - 前端
tags:
  - JavaScript
  - CSS
  - 浏览器
---

<custom-header/>

### 浏览器渲染步骤

1. **DOM**：将 HTML 解析成 DOM 树，开发者可以在控制台输入`document`感知它的存在。

2. **Style**：解析 CSS，开发者可以在控制输入`document.styleSheets`感知它的存在。

3. **Layout**：构建布局树，布局树会移除 DOM 树不可见的部分，并计算可见部分的`几何位置`

4. **Layer**：将页面划分多个图层，一些层叠上下文 CSS 属性（比如 z-index、opacity、
   position）、“由于显示不全被裁剪的内容”等会使 DOM 元素形成独立的图层。

5. **Paint**：为每个图层生成包含“绘制信息”的绘制列表，将绘制列表提交给渲染进程的合成线程用于绘制。

---

执行上述任务的流程被称为“渲染流水线”，每次执行流水线时，上述所有任务并不一定全部执行，比如：

- 当通过 JS 或者 CSS 修改了 DOM 元素的几何位置（比如长度、宽度）时，会触发完成的渲染流水线，这种情况成为`重排`。

- 当修改的属性不涉及几何属性（比如字体颜色）时，会省略流流水线中的`Layout、Layer`过程，这种情况成为`重绘`。

- 当修改“不涉及重排、重绘的属性”（比如 transform 属性）时，会省略流水线中的`Layout、Layer、Paint`过程，仅执行`合成线程`的绘制工作，这种情况称为`合成`

按照“性能高低“对这些流程进行排序：`重排 < 重绘 < 合成`。这也是 CSS 动画性能优于 JS 动画性能的原因，前者可能仅涉及`合成`，后者会涉及到`重排、重绘`。

### 重绘和回流（重排）详细描述

:::tip 重绘（repaint）
当 render tree 中的一些元素需要更新属性，而这些属性只是影响元素的外观，风格，而不会影响布局的，比如 background-color。则就叫称为重绘。

当你给一个元素更换颜色，这样的行为是不会影响页面布局的，DOM 树不会变化，但颜色变了，渲染树得重新渲染页面，这就是重绘。
:::

:::tip 回流（重排）（reflow）
当 render tree 中的一部分(或全部)因为元素的规模尺寸，布局，隐藏等改变而需要重新构建。这就称为回流(reflow)。

增删 DOM 节点，修改一个元素的宽高，页面布局发生变化，DOM 树结构发生变化，那么肯定要重新构建 DOM 树，而 DOM 树与渲染树是紧密相连的，DOM 树构建完，渲染树也会随之对页面进行再次渲染，这个过程就叫回流。

:::

**<font color="red">如何减少回流（重排）</font>**

1. DOM 的增删行为
   比如你要删除某个节点，给某个父元素增加子元素，这类操作都会引起回流。如果要加多个子元素，最好使用 documentfragment。

2. 几何属性的变化
   比如元素宽高变了，border 变了，字体大小变了，这种直接会引起页面布局变化的操作也会引起回流。如果你要改变多个属性，最好将这些属性定义在一个 class 中，直接修改 class 名，这样只用引起一次回流。

3. 元素位置的变化
   修改一个元素的左右 margin，padding 之类的操作，所以在做元素位移的动画，不要更改 margin 之类的属性，使用定位脱离文档流后改变位置会更好。

4. 获取元素的偏移量属性
   例如获取一个元素的 scrollTop、scrollLeft、scrollWidth、offsetTop、offsetLeft、offsetWidth、offsetHeight 之类的属性，浏览器为了保证值的正确也会回流取得最新的值，所以如果你要多次操作，最好取完做个缓存。

5. 页面初次渲染
   这样的回流无法避免

6. 浏览器窗口尺寸改变
   resize 事件发生也会引起回流。

---

[重绘和回流的应用场景](https://blog.csdn.net/qq_39583550/article/details/128381589)
