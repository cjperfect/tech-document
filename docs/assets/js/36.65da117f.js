(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{341:function(t,a,s){"use strict";s.r(a);var n=s(8),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("custom-header"),t._v(" "),a("p",[t._v("更新过程中可控的主要体现在以下几个方面：")]),t._v(" "),a("ol",[a("li",[t._v("任务拆分")]),t._v(" "),a("li",[t._v("任务的挂起、恢复、终止")]),t._v(" "),a("li",[t._v("任务具备优先级")])]),t._v(" "),a("h2",{attrs:{id:"任务的拆分"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#任务的拆分"}},[t._v("#")]),t._v(" 任务的拆分")]),t._v(" "),a("p",[t._v("在 React Fiber 中，它采用的是"),a("code",[t._v("化整为零")]),t._v("的战术，将 render 协调阶段递归遍历（深度优先遍历）VDOM 这个大任务拆分成若干个小任务，每个任务只负责一个节点的处理。")]),t._v(" "),a("div",{staticClass:"language-jsx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-jsx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"react"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" ReactDom "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"react-dom"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" jsx "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("A1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n    A1     \n    ")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("B1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n      B1       \n      ")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("C1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("C1")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n      ")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("C2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("C2")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n    ")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n    ")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("B2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("B2")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token plain-text"}},[t._v("\n  ")]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReactDom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("jsx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("这个组件在渲染的时候会被分成八个小任务，每个任务用来分别处理 "),a("code",[t._v("A1(div)、A1(text)、B1(div)、B1(text)、C1(div)、C1(text)、C2(div)、C2(text)、B2(div)、B2(text)")]),t._v("。")]),t._v(" "),a("p",[t._v("再通过时间分片，在一个时间片中执行一个或者多个任务。这里提一下，所有的小任务并不是一次性被切分完成，而是处理当前任务的时候生成下一个任务，如果没有下一个任务生成了，就代表本次渲染的 Diff 操作完成。")]),t._v(" "),a("blockquote",[a("p",[t._v("时间分片指的是一种将多个粒度小的任务放入一个时间切片（一帧）中执行的一种方案，在 React Fiber 中就是将多个任务放在了一个时间片中去执行。")])]),t._v(" "),a("h2",{attrs:{id:"任务的挂起、恢复、终止"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#任务的挂起、恢复、终止"}},[t._v("#")]),t._v(" 任务的挂起、恢复、终止")]),t._v(" "),a("p",[t._v("在探讨这个知识之前，回顾一下 React 更新过程中涉及到的两棵树，一个是当前的 fiber 树（"),a("code",[t._v("currentFiber tree")]),t._v("）和正在构建的新树（"),a("code",[t._v("workInProgress tree")]),t._v("）。")]),t._v(" "),a("ul",[a("li",[a("p",[a("strong",[t._v("currentFiber tree")])]),t._v(" "),a("p",[t._v("指的是上一次渲染构建的 fiber 树，在每次更新完成过后会把 "),a("code",[t._v("workInProgress tree")]),t._v(" 赋值给"),a("code",[t._v("currentFiber tree")]),t._v("，两颗树上面的 fiber 节点是通过"),a("code",[t._v("alternate")]),t._v("属性进行联系的。")]),t._v(" "),a("p",[t._v("在新的"),a("code",[t._v("workInProgress tree")]),t._v("的构建过程中，会和"),a("code",[t._v("currentFiber tree")]),t._v("对应的节点进行 diff 比较，收集副作用。如果 fiber 节点没有什么变化，那就直接复用和 "),a("code",[t._v("currentFiber tree")]),t._v(" 对应的节点，减少创建对象带来的开销。也就是说"),a("strong",[t._v("无论是创建还是更新、挂起、恢复以及终止操作都是发生在 workInProgress tree 创建过程中的")]),t._v("。\n"),a("code",[t._v("workInProgress tree")]),t._v(" 构建过程其实就是循环的执行任务和创建下一个任务。")])])]),t._v(" "),a("h3",{attrs:{id:"挂起"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#挂起"}},[t._v("#")]),t._v(" 挂起")]),t._v(" "),a("p",[t._v("当第一个小任务完成后，先判断这一帧是否还有"),a("strong",[t._v("空闲时间")]),t._v("，没有就挂起下一任务的执行，记住当前挂起的节点，把控制权交还给浏览器去执行更高优先级的任务。")]),t._v(" "),a("h3",{attrs:{id:"恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#恢复"}},[t._v("#")]),t._v(" 恢复")]),t._v(" "),a("p",[t._v("在浏览器渲染一帧后，判断当前帧是否有"),a("strong",[t._v("空闲时间")]),t._v("，如果有就恢复之前挂起的任务，如果没有任务需要执行，说明协调（reconciliation）阶段完成了，可以开始进入渲染阶段了。")]),t._v(" "),a("ul",[a("li",[a("p",[a("strong",[t._v("如何知道这一帧是否有空闲时间")]),t._v("？")]),t._v(" "),a("p",[t._v("采用浏览器原生 API，"),a("code",[t._v("requestIdleCallback")]),t._v("，React 源码中为了兼容低版本的浏览器，对该方法进行了 P\nolyfill。"),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback",target:"_blank",rel:"noopener noreferrer"}},[t._v("MDN---requestIdleCallback"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("恢复执行的时候有如何知道下一个任务是什么")]),t._v("？")]),t._v(" "),a("p",[t._v("在前面的文章说到过 fiber 是一个链表结构，每一个任务就是处理一个 FiberNode 对象，然后又生成下一个任务需要处理的 FiberNode 对象。")])])]),t._v(" "),a("h3",{attrs:{id:"终止"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#终止"}},[t._v("#")]),t._v(" 终止")]),t._v(" "),a("p",[t._v("其实并不是每次更新都会走到 commit 阶段，在协调阶段过程中出发了新的更新，在执行下一个任务的时候，会判断"),a("strong",[t._v("是否存在优先级更好的执行任务")]),t._v("，如果有就要终止原来准备要执行的任务，开始新的 workInProgress tree 树的构建，开始新的更新流程，这样可以避免重复更新操作。")]),t._v(" "),a("h2",{attrs:{id:"任务具备优先级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#任务具备优先级"}},[t._v("#")]),t._v(" 任务具备优先级")]),t._v(" "),a("p",[t._v("待续。。。")]),t._v(" "),a("p",[t._v("参考文章：")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://segmentfault.com/a/1190000039682751",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://segmentfault.com/a/1190000039682751"),a("OutboundLink")],1)])])],1)}),[],!1,null,null,null);a.default=e.exports}}]);