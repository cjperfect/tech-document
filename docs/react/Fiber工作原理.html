<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浅谈React Fiber工作原理 | 技术文档</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="technology-review">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/tech-document/assets/css/0.styles.afad9826.css" as="style"><link rel="preload" href="/tech-document/assets/js/app.7336957d.js" as="script"><link rel="preload" href="/tech-document/assets/js/2.4e1184b4.js" as="script"><link rel="preload" href="/tech-document/assets/js/4.254b04cb.js" as="script"><link rel="preload" href="/tech-document/assets/js/12.c2ba2865.js" as="script"><link rel="prefetch" href="/tech-document/assets/js/10.403778a6.js"><link rel="prefetch" href="/tech-document/assets/js/11.1b3238dc.js"><link rel="prefetch" href="/tech-document/assets/js/13.10289b8b.js"><link rel="prefetch" href="/tech-document/assets/js/14.d292f43c.js"><link rel="prefetch" href="/tech-document/assets/js/15.2194d6d3.js"><link rel="prefetch" href="/tech-document/assets/js/16.42e9ba11.js"><link rel="prefetch" href="/tech-document/assets/js/17.a49afd61.js"><link rel="prefetch" href="/tech-document/assets/js/18.98476456.js"><link rel="prefetch" href="/tech-document/assets/js/19.29a251d2.js"><link rel="prefetch" href="/tech-document/assets/js/20.ca55bb01.js"><link rel="prefetch" href="/tech-document/assets/js/21.ae42376a.js"><link rel="prefetch" href="/tech-document/assets/js/22.b1bc092f.js"><link rel="prefetch" href="/tech-document/assets/js/23.38f4ebdf.js"><link rel="prefetch" href="/tech-document/assets/js/24.8c3f712c.js"><link rel="prefetch" href="/tech-document/assets/js/25.317efa81.js"><link rel="prefetch" href="/tech-document/assets/js/26.afeef7fe.js"><link rel="prefetch" href="/tech-document/assets/js/27.44fccbaf.js"><link rel="prefetch" href="/tech-document/assets/js/28.290da4aa.js"><link rel="prefetch" href="/tech-document/assets/js/29.fa50ae0a.js"><link rel="prefetch" href="/tech-document/assets/js/3.414f2d7e.js"><link rel="prefetch" href="/tech-document/assets/js/30.88d887a4.js"><link rel="prefetch" href="/tech-document/assets/js/31.567937c9.js"><link rel="prefetch" href="/tech-document/assets/js/32.27fa7a1a.js"><link rel="prefetch" href="/tech-document/assets/js/33.4eb80605.js"><link rel="prefetch" href="/tech-document/assets/js/34.cf229122.js"><link rel="prefetch" href="/tech-document/assets/js/35.945a7237.js"><link rel="prefetch" href="/tech-document/assets/js/36.d0a4767e.js"><link rel="prefetch" href="/tech-document/assets/js/37.4c6954a0.js"><link rel="prefetch" href="/tech-document/assets/js/38.2bccf61b.js"><link rel="prefetch" href="/tech-document/assets/js/39.2040339f.js"><link rel="prefetch" href="/tech-document/assets/js/40.cc2c8a0d.js"><link rel="prefetch" href="/tech-document/assets/js/41.61cf17ce.js"><link rel="prefetch" href="/tech-document/assets/js/42.b38eb7ca.js"><link rel="prefetch" href="/tech-document/assets/js/43.4ea8ba50.js"><link rel="prefetch" href="/tech-document/assets/js/5.44a12058.js"><link rel="prefetch" href="/tech-document/assets/js/6.237b9cc2.js"><link rel="prefetch" href="/tech-document/assets/js/7.d32d6951.js"><link rel="prefetch" href="/tech-document/assets/js/8.4049e9dd.js"><link rel="prefetch" href="/tech-document/assets/js/9.bec82895.js">
    <link rel="stylesheet" href="/tech-document/assets/css/0.styles.afad9826.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/tech-document/" class="home-link router-link-active"><!----> <span class="site-name">技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/tech-document/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/tech-document/archive/" class="nav-link">
  文章归档
</a></div><div class="nav-item"><a href="/tech-document/css/" class="nav-link">
  HTML/CSS
</a></div><div class="nav-item"><a href="/tech-document/javascript/" class="nav-link">
  Javascript
</a></div><div class="nav-item"><a href="/tech-document/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/tech-document/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/tech-document/typescript/" class="nav-link">
  Typescript
</a></div><div class="nav-item"><a href="/tech-document/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/tech-document/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/tech-document/network/" class="nav-link">
  网络知识
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人博客" class="dropdown-title"><span class="title">个人博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="个人博客" class="mobile-dropdown-title"><span class="title">个人博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/qq_39583550" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://cjperfect.gitee.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/tech-document/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/tech-document/archive/" class="nav-link">
  文章归档
</a></div><div class="nav-item"><a href="/tech-document/css/" class="nav-link">
  HTML/CSS
</a></div><div class="nav-item"><a href="/tech-document/javascript/" class="nav-link">
  Javascript
</a></div><div class="nav-item"><a href="/tech-document/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/tech-document/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/tech-document/typescript/" class="nav-link">
  Typescript
</a></div><div class="nav-item"><a href="/tech-document/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/tech-document/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/tech-document/network/" class="nav-link">
  网络知识
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人博客" class="dropdown-title"><span class="title">个人博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="个人博客" class="mobile-dropdown-title"><span class="title">个人博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/qq_39583550" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://cjperfect.gitee.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tech-document/react/" aria-current="page" class="sidebar-link">React中小知识点</a></li><li><a href="/tech-document/react/0浅谈副作用.html" class="sidebar-link">浅谈React副作用</a></li><li><a href="/tech-document/react/1浅谈Fiber是什么，解决了什么问题.html" class="sidebar-link">浅谈Fiber是什么，解决了什么问题</a></li><li><a href="/tech-document/react/2浅谈Fiber架构下React是如何更新的.html" class="sidebar-link">浅谈Fiber架构下React是如何更新的</a></li><li><a href="/tech-document/react/3浅谈ReactFiber是如何实现更新过程可控.html" class="sidebar-link">浅谈React Fiber如何实现更新过程可控</a></li><li><a href="/tech-document/react/Fiber工作原理.html" class="active sidebar-link">浅谈React Fiber工作原理</a></li><li><a href="/tech-document/react/React架构演变.html" class="sidebar-link">React架构演变</a></li><li><a href="/tech-document/react/阅读React源码前的序章.html" class="sidebar-link">阅读React源码前的序章</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><div class="custom-header" data-v-46893521><h1 class="title" data-v-46893521></h1> <div class="name" data-v-46893521>
    作者:
    <span data-v-46893521></span></div> <div class="categories" data-v-46893521>
    分类:
    </div> <div class="tags" data-v-46893521>
    标签:
    </div> <div class="date" data-v-46893521>
    创建时间:
    <span data-v-46893521></span></div></div> <h2 id="静态数据结构"><a href="#静态数据结构" class="header-anchor">#</a> 静态数据结构</h2> <p>每个 Fiber 节点对应一个组件，保存了该组件的类型，对应的 DOM 节点的对应信息。</p> <p>FiberRootNode 有且仅有一个，而 rootFiber 可以有多个，因为我们可以挂载多个应用（也就是多次调用<code>ReactDOM.render</code>）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
      chenjiang
      <span class="token punctuation">{</span>age<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最终形成数据结构如下：</p> <p><img src="/tech-document/assets/img/1677589785791.5be7ac49.png" alt="1677589785791"></p> <h3 id="fiber-的数据结构"><a href="#fiber-的数据结构" class="header-anchor">#</a> Fiber 的数据结构</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">tag</span><span class="token operator">:</span> WorkTag<span class="token punctuation">,</span> <span class="token literal-property property">pendingProps</span><span class="token operator">:</span> mixed<span class="token punctuation">,</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span> <span class="token literal-property property">mode</span><span class="token operator">:</span> TypeOfMode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Instance</span>

  <span class="token comment">// 组件的类型 FunctionComponent、classComponent、HostComponent（指的是DOM节点对应的Fiber节点）</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>

  <span class="token comment">// 大多数情况下于tag相同，使用React.memo包裹时候，elementType和tag不同</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>elementType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 对于FunctionComponent，指函数本身</span>
  <span class="token comment">// 对于ClassComponent，指class</span>
  <span class="token comment">// 对于HostComponet，指的是DOM节点tagName</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 对于HostComponent来说指的是对应的真实的DOM节点</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 以下属性用于连接其他Fiber节点形成Fiber树。</span>

  <span class="token comment">// 指向父fiber节点</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 指向第一个子fiber节点</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 指向第一个兄弟fiber节点</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// ref属性</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 新传入的 props</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>

  <span class="token comment">// 之前的 props</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 更新队列，用于暂存 setState 的值</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// 之前的 state</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>

  <span class="token comment">// 保存本次更新会造成的DOM操作。比如删除，移动</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>childLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token comment">//用于链接新树和旧树；旧-&gt;新，新-&gt;旧</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="动态的工作单元"><a href="#动态的工作单元" class="header-anchor">#</a> 动态的工作单元</h2> <p>Fiber 可以理解成一个工作单元，每次执行完一个工作单元，react 就会检查还剩余多少时间，如果没有就把控制权交还给浏览器。React Fiber 与浏览器的核心交互过程如下：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78a602cbc87342628ace49abb5d20c39~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="undefined"></p> <p>首先 React 向浏览器请求调度，浏览器在一帧中如果还有空闲时间，会去判断是否存在待执行任务，不存在就直接将控制权交给浏览器，如果存在就会执行对应的任务，执行完成后会判断是否还有时间，有时间且有待执行任务则会继续执行下一个任务，否则就会将控制权交给浏览器。</p> <p>Fiber 可以被理解为划分一个个更小的工作单元，它是把一个大任务拆分为了很多个小块任务，一个小块任务的执行必须是一次完成的，不能出现暂停，但是一个小块任务执行完后可以移交控制权给浏览器去响应用户，从而不用等待大任务一直执行完成再去响应用户。</p> <h2 id="架构-双缓存工作机制"><a href="#架构-双缓存工作机制" class="header-anchor">#</a> 架构（双缓存工作机制）</h2> <h3 id="什么是双缓存"><a href="#什么是双缓存" class="header-anchor">#</a> 什么是双缓存</h3> <p>当我们用<code>canvas</code>绘制动画，每一帧绘制前都会调用<code>ctx.clearRect</code>清除上一帧的画面。如果当前帧画面计算量比较大，导致清除上一帧画面到绘制当前帧画面之间有较长间隙，就会出现白屏闪烁。</p> <p>为了解决这个问题，我们可以在<code>内存中</code>绘制当前帧动画，绘制完毕后直接用当前帧替换上一帧画面，由于省去了两帧替换间的计算时间，不会出现从白屏到出现画面的闪烁情况。</p> <p>这种<strong>在内存中构建并直接替换</strong>的技术叫做<a href="https://link.juejin.cn?target=https%3A%2F%2Fbaike.baidu.com%2Fitem%2F%E5%8F%8C%E7%BC%93%E5%86%B2" target="_blank" rel="noopener noreferrer">双缓存<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p><code>React</code>使用“双缓存”来完成<code>Fiber树</code>的构建与替换——对应着<code>DOM树</code>的创建与更新。</p> <h3 id="双缓存-fiber-树"><a href="#双缓存-fiber-树" class="header-anchor">#</a> 双缓存 Fiber 树</h3> <p>React 中存在两棵树，一颗为<code>current Fiber tree</code>，另外一颗为<code>workInProgress Fiber tree</code>。</p> <ul><li><code>current Fiber tree</code>也就是当前页面中显示内容对应的 Fiber 树，每个 Fiber 节点成为 current fiber。</li> <li><code>workInProgress Fiber tree</code>正在内存中构建的 Fiber 树。</li></ul> <p>两颗树的 fiber 节点是通过<code>alternate</code>属性进行连接的。</p> <div class="language-js extra-class"><pre class="language-js"><code>currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> workInProgressFiber<span class="token punctuation">;</span>
workInProgressFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> currentFiber<span class="token punctuation">;</span>
</code></pre></div><p>React 的根节点（FiberRootNode）通过 current 指针在不同的 Fiber 树的 rootFiber 间切换来实现 Fiber 树的切换。</p> <p><img src="/tech-document/assets/img/animate.c506839f.gif" alt="动画"></p> <h4 id="fiber-树的构建-挂载阶段、更新阶段"><a href="#fiber-树的构建-挂载阶段、更新阶段" class="header-anchor">#</a> Fiber 树的构建（挂载阶段、更新阶段）</h4> <p>再次强调：FiberRootNode 有且仅有一个，而 rootFiber 可以有多个，因为我们可以挂载多个应用（也就是多次调用<code>ReactDOM.render</code>）</p> <p>以下代码为例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div
      onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">&gt;</span>
      <span class="token punctuation">{</span>age<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>挂载阶段（mount 阶段）</strong></p> <p>当<code>首次调用ReactDOM.render</code>就会创建<code>FiberRootNode</code>，每次调用<code>ReactDOM.render</code>就会创建当前应用的根节点<code>RootFiber</code>，由于在首屏渲染之前页面是空白的，因此<code>RootFiber</code>不存在子节点。</p> <p><img src="data:image/png;base64,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" alt="1677676221915"></p> <p><strong>挂载阶段流程如下（首屏渲染）</strong></p> <p>首先创建 fiber 树的根节点<code>RootFiber</code>，在两棵树之间都存在的 Fiber 节点用<code>alternate</code>连接，接下来采用深度遍历的方式创建 Fiber 树，当<code>workInProgress Fiber tree</code>完成了渲染，最后 FiberRootNode 的 current 指针就指向<code>workInProgress Fiber tree</code>的根节点，此时就变成<code>current Fiber tree</code>。</p> <p><img src="/tech-document/assets/img/animate-1677677631515.d3e3cbfa.gif" alt="animate"></p> <p><strong>更新阶段 （update 阶段）</strong></p> <p>每次触发更新都会重新创建一颗<code>workInProgress Fiber Tree</code>，<code>current Fiber</code>与本次更新返回的<code>JSX</code>做对比，生成<code>workInProgress Fiber</code>的过程就是 diff 算法，update 阶段与 mount 阶段，最大的区别就是是否有 diff 算法。</p> <p><img src="/tech-document/assets/img/animate-1677679212081.3e1e4a4e.gif" alt="animate"></p> <p>参考文章：</p> <ul><li><a href="https://juejin.cn/post/6844904202104209415" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844904202104209415<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.cn/post/6943896410987659277" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6943896410987659277<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tech-document/react/3浅谈ReactFiber是如何实现更新过程可控.html" class="prev">
        浅谈React Fiber如何实现更新过程可控
      </a></span> <span class="next"><a href="/tech-document/react/React架构演变.html">
        React架构演变
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/tech-document/assets/js/app.7336957d.js" defer></script><script src="/tech-document/assets/js/2.4e1184b4.js" defer></script><script src="/tech-document/assets/js/4.254b04cb.js" defer></script><script src="/tech-document/assets/js/12.c2ba2865.js" defer></script>
  </body>
</html>
