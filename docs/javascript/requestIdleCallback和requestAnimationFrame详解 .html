<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>requestIdleCallback和requestAnimationFrame详解 | 技术文档</title>
    <meta name="generator" content="VuePress 1.9.8">
    
    <meta name="description" content="technology-review">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/tech-document/assets/css/0.styles.6ea35751.css" as="style"><link rel="preload" href="/tech-document/assets/js/app.14573134.js" as="script"><link rel="preload" href="/tech-document/assets/js/2.b455ce25.js" as="script"><link rel="preload" href="/tech-document/assets/js/10.55a4eba0.js" as="script"><link rel="preload" href="/tech-document/assets/js/9.d1bac2c8.js" as="script"><link rel="prefetch" href="/tech-document/assets/js/11.ec5b5339.js"><link rel="prefetch" href="/tech-document/assets/js/12.9523586e.js"><link rel="prefetch" href="/tech-document/assets/js/13.a284cb8e.js"><link rel="prefetch" href="/tech-document/assets/js/14.97ab619e.js"><link rel="prefetch" href="/tech-document/assets/js/15.06ba8bf3.js"><link rel="prefetch" href="/tech-document/assets/js/16.04e1d056.js"><link rel="prefetch" href="/tech-document/assets/js/17.b73ad9d1.js"><link rel="prefetch" href="/tech-document/assets/js/18.8ea7e517.js"><link rel="prefetch" href="/tech-document/assets/js/19.05ceb7ab.js"><link rel="prefetch" href="/tech-document/assets/js/20.d5e624be.js"><link rel="prefetch" href="/tech-document/assets/js/21.697f15a2.js"><link rel="prefetch" href="/tech-document/assets/js/22.eafae40c.js"><link rel="prefetch" href="/tech-document/assets/js/23.90b5fd71.js"><link rel="prefetch" href="/tech-document/assets/js/24.6de610c1.js"><link rel="prefetch" href="/tech-document/assets/js/25.ac0e00e8.js"><link rel="prefetch" href="/tech-document/assets/js/26.0ed86428.js"><link rel="prefetch" href="/tech-document/assets/js/3.3346d0f5.js"><link rel="prefetch" href="/tech-document/assets/js/4.513edc5d.js"><link rel="prefetch" href="/tech-document/assets/js/5.8827e209.js"><link rel="prefetch" href="/tech-document/assets/js/6.4c0119b2.js"><link rel="prefetch" href="/tech-document/assets/js/7.10f32013.js"><link rel="prefetch" href="/tech-document/assets/js/8.2f0278cd.js">
    <link rel="stylesheet" href="/tech-document/assets/css/0.styles.6ea35751.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/tech-document/" class="home-link router-link-active"><!----> <span class="site-name">技术文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/tech-document/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/tech-document/archive/" class="nav-link">
  文章归档
</a></div><div class="nav-item"><a href="/tech-document/css/" class="nav-link">
  HTML/CSS
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Javascript" class="dropdown-title"><span class="title">Javascript</span> <span class="arrow down"></span></button> <button type="button" aria-label="Javascript" class="mobile-dropdown-title"><span class="title">Javascript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tech-document/javascript/" class="nav-link router-link-active">
  原生JS
</a></li><li class="dropdown-item"><!----> <a href="/tech-document/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/tech-document/vue/" class="nav-link">
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/tech-document/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/tech-document/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/tech-document/network/" class="nav-link">
  网络知识
</a></div><div class="nav-item"><a href="https://blog.csdn.net/qq_39583550" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://cjperfect.gitee.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/tech-document/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/tech-document/archive/" class="nav-link">
  文章归档
</a></div><div class="nav-item"><a href="/tech-document/css/" class="nav-link">
  HTML/CSS
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Javascript" class="dropdown-title"><span class="title">Javascript</span> <span class="arrow down"></span></button> <button type="button" aria-label="Javascript" class="mobile-dropdown-title"><span class="title">Javascript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tech-document/javascript/" class="nav-link router-link-active">
  原生JS
</a></li><li class="dropdown-item"><!----> <a href="/tech-document/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/tech-document/vue/" class="nav-link">
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/tech-document/webpack/" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/tech-document/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/tech-document/network/" class="nav-link">
  网络知识
</a></div><div class="nav-item"><a href="https://blog.csdn.net/qq_39583550" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://cjperfect.gitee.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人工具
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tech-document/javascript/" aria-current="page" class="sidebar-link">Map 和 WeakMap 区别以及使用场景</a></li><li><a href="/tech-document/javascript/Ajax、axios、fetch的区别.html" class="sidebar-link">Ajax、axios、fetch的区别</a></li><li><a href="/tech-document/javascript/Objectis和===的区别.html" class="sidebar-link">Object.is和===区别</a></li><li><a href="/tech-document/javascript/requestIdleCallback和requestAnimationFrame详解 .html" class="active sidebar-link">requestIdleCallback和requestAnimationFrame详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tech-document/javascript/requestIdleCallback和requestAnimationFrame详解 .html#浏览器每一帧都做了哪些事情呢" class="sidebar-link">浏览器每一帧都做了哪些事情呢？</a></li><li class="sidebar-sub-header"><a href="/tech-document/javascript/requestIdleCallback和requestAnimationFrame详解 .html#requestidlecallback" class="sidebar-link">requestIdleCallback</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tech-document/javascript/requestIdleCallback和requestAnimationFrame详解 .html#requestidlecallback-基本使用" class="sidebar-link">requestIdleCallback 基本使用</a></li><li class="sidebar-sub-header"><a href="/tech-document/javascript/requestIdleCallback和requestAnimationFrame详解 .html#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/tech-document/javascript/requestIdleCallback和requestAnimationFrame详解 .html#requestanimationframe" class="sidebar-link">requestAnimationFrame</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tech-document/javascript/requestIdleCallback和requestAnimationFrame详解 .html#requestanimationframe-基本使用" class="sidebar-link">requestAnimationFrame 基本使用</a></li></ul></li></ul></li><li><a href="/tech-document/javascript/原型与原型链.html" class="sidebar-link">原型与原型链</a></li><li><a href="/tech-document/javascript/浏览器的重绘和回流.html" class="sidebar-link">浏览器的重绘和回流</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><div class="custom-header" data-v-46893521><h1 class="title" data-v-46893521></h1> <div class="name" data-v-46893521>
    作者:
    <span data-v-46893521></span></div> <div class="categories" data-v-46893521>
    分类:
    </div> <div class="tags" data-v-46893521>
    标签:
    </div> <div class="date" data-v-46893521>
    创建时间:
    <span data-v-46893521></span></div></div> <p>这个知识点是 React Fiber 发扬出来的，做一个大致的了解。</p> <p>页面是一帧一帧的绘制出来，当每秒绘制的帧数（FPS）达到 60 时，页面是流畅的，小于这个值时，用户会感觉到卡顿。1s 60 帧，所以每一帧分到的时间是 1000/60 ≈ 16 ms。</p> <h2 id="浏览器每一帧都做了哪些事情呢"><a href="#浏览器每一帧都做了哪些事情呢" class="header-anchor">#</a> 浏览器每一帧都做了哪些事情呢？</h2> <p><img src="/tech-document/assets/img/frame.94d12de7.png" alt="frame"></p> <p>从上图，我们可以分析，一帧内（16ms）做了什么事情？</p> <div class="custom-block tip"><p class="custom-block-title">一帧内做了什么事情</p> <ol><li>处理用户的交互</li> <li>JS 的解析和执行</li> <li>帧的开始，处理页面尺寸的变化，滚动事件，媒体查询，动画事件。</li> <li>处理<code>requestAnimationFrame</code>和<code>IntersectionObserver</code>的回调函数。</li> <li>布局（重新计算样式，更新布局，处理<code>ResizeObserver</code>的回调函数）。</li> <li>绘制页面</li></ol></div> <h2 id="requestidlecallback"><a href="#requestidlecallback" class="header-anchor">#</a> requestIdleCallback</h2> <p>如果上面的 6 个步骤完成过后没超过 16ms，说明还有浏览器还有空闲时间，这时浏览器就会去执行<code>requestIdleCallback</code>的回调函数。</p> <p>到目前为止，可以做一个初步的了解。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p><code>requestAnimationFrame</code>是每一帧都会执行。</p> <p><code>requestIdleCallback</code>是浏览器有空闲时间才会执行。</p> <p>（如果浏览器一直处于忙碌状态，那么<code>requestIdleCallback</code>的回调永远不会执行，可以通过设置<code>timeout</code>参数来保证运行。）</p></div> <h3 id="requestidlecallback-基本使用"><a href="#requestidlecallback-基本使用" class="header-anchor">#</a> requestIdleCallback 基本使用</h3> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback" target="_blank" rel="noopener noreferrer">MDN 介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> taskQueue <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;任务1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;任务2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;任务3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;任务4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 向浏览器申请空闲时间，用来执行wookloop，</span>
<span class="token comment">// 如果没有空闲时间，此时会等待指定的 timeout 那么久再执行</span>
<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>wookloop<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">wookloop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>deadline<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 帧内还有空闲时间，或者超时了且任务队列中还有任务，就要执行任务了</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>
    <span class="token punctuation">(</span>deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> deadline<span class="token punctuation">.</span>didTimeout<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    taskQueue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> currentWork <span class="token operator">=</span> taskQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取出任务</span>
    <span class="token function">currentWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行任务</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//   如果任务队列中还有任务， 那么接着向浏览器申请下一帧的空闲时间</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>taskQueue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>wookloop<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="data:image/png;base64,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" alt="1675234864484"></p> <div class="custom-block tip"><p class="custom-block-title">分析</p> <p>分两种情况：</p> <ul><li><p>没有超时，说明浏览器不忙，有空闲时间用来执行 wookloop</p></li> <li><p>超时了，浏览器一直处于忙碌状态，那么<code>requestIdleCallback</code>的回调会等待指定的 <code>timeout</code> 那么久再执行 （如果超时状态还选择继续执行的话，肯定会出现卡顿，因为会将一帧的时间拉长。）</p></li></ul></div> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>一些低优先级的任务可使用 <code>requestIdleCallback</code> 等浏览器不忙的时候来执行，同时因为时间有限，它所执行的任务应该尽量是能够量化，细分的微任务（micro task）。（有时间但是不多，这时执行的回调函数功能很大，导致执行时间很长，就会将一帧拉的很长，导致卡顿。）</p> <div class="custom-block danger"><p class="custom-block-title">注意</p> <ul><li><p>因为它发生在一帧的最后，此时页面布局已经完成，<strong>所以不建议在 <code>requestIdleCallback</code> 里再操作 DOM</strong>，这样会导致页面再次重绘。</p></li> <li><p><strong>DOM 操作建议在 rAF 中进行</strong>。同时，操作 DOM 所需要的耗时是不确定的，因为会导致重新计算布局和视图的绘制，所以这类操作不具备可预测性。</p></li> <li><p><code>Promise</code> 也不建议在这里面进行，因为 Promise 的回调属性 Event loop 中优先级较高的一种微任务，会在 <code>requestIdleCallback</code> 结束时立即执行，不管此时是否还有富余的时间，这样有很大可能会让一帧超过 16 ms。</p></li></ul></div> <h2 id="requestanimationframe"><a href="#requestanimationframe" class="header-anchor">#</a> requestAnimationFrame</h2> <p>在没有 <code>requestAnimationFrame</code> 方法的时候，执行动画，我们可能使用 <code>setTimeout</code> 或 <code>setInterval</code> 定时器来实现动画；但是用定时器会出现一种问题，它的回调函数执行的时间是不固定的，可能刚好就在末尾，或者直接就不执行了，经常会引起丢帧而导致页面卡顿。</p> <div class="custom-block tip"><p class="custom-block-title">个人理解</p> <ul><li><p>刚好在末尾执行，那么导致这一帧时间拉的很长，导致卡顿；（某一帧执行时间长，那么 1s 渲染的帧数就小于 60 帧，因此就感觉卡顿）</p></li> <li><p>不执行，例如在动画中定时器回调没有执行，导致这一帧没有变化（丢帧）；</p></li></ul></div> <p><code>setTimeout</code> 或 <code>setInterval</code> 的回调函数要先等同步代码执行完毕，异步队列中没有其他任务，才会轮到自己执行。并且，我们知道每一次重新渲染的最佳时间大约是 16.6 ms，如果定时器的时间间隔过短，就会造成过度渲染，增加开销；过长又会延迟渲染，使动画不流畅。</p> <p><code>requestAnimationFrame</code> 方法不同与 <code>setTimeout</code> 或 <code>setInterval</code>，它是由系统来决定回调函数的执行时机的，会请求浏览器在下一次重新渲染之前执行回调函数。无论设备的刷新率是多少，<strong><code>requestAnimationFrame</code> 的时间间隔都会紧跟屏幕刷新一次所需要的时间</strong>；</p> <p>例如某一设备的刷新率是 75 Hz，那这时的时间间隔就是 13.3 ms（1 秒 / 75 次）。需要注意的是这个方法虽然能够<strong>保证回调函数在每一帧内只渲染一次</strong>，但是<strong>如果这一帧有太多任务执行，还是会造成卡顿的；因此它只能保证重新渲染的时间间隔最短是屏幕的刷新时间。</strong></p> <h3 id="requestanimationframe-基本使用"><a href="#requestanimationframe-基本使用" class="header-anchor">#</a> requestAnimationFrame 基本使用</h3> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame" target="_blank" rel="noopener noreferrer">MDN 介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
      <span class="token selector">.box</span> <span class="token punctuation">{</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">background</span><span class="token punctuation">:</span> plum<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">let</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> animationId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> box <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;.box&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        left <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">cancelAnimationFrame</span><span class="token punctuation">(</span>animationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          box<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateX(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>left<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
          animationId <span class="token operator">=</span> <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><hr> <p><a href="https://juejin.cn/post/6844903848981577735" target="_blank" rel="noopener noreferrer">原文地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tech-document/javascript/Objectis和===的区别.html" class="prev">
        Object.is和===区别
      </a></span> <span class="next"><a href="/tech-document/javascript/原型与原型链.html">
        原型与原型链
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/tech-document/assets/js/app.14573134.js" defer></script><script src="/tech-document/assets/js/2.b455ce25.js" defer></script><script src="/tech-document/assets/js/10.55a4eba0.js" defer></script><script src="/tech-document/assets/js/9.d1bac2c8.js" defer></script>
  </body>
</html>
